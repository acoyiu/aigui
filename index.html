<head>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        #fsBut {
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 999999;
        }
    </style>
</head>

<body>

    <button id="fsBut" onclick="fS()">Full Screen</button>
    <div id="container"></div>

    <script src="./aijs.build4.js"></script>
    <script src="./updateAction.js"></script>
    <script src="./updateTransition.js"></script>
    <script>
        const MissionCache = {
            allPages: [],
            namedObj: {},
            gameSet: [],
            actElement: [],
            pageChanger: [],
            transitioner: [],
            allInteractive: [],
        };

        const start = async () => {
            document.getElementById('container').style.opacity = 0;

            let svgText = await (await fetch('./svg/test-01.svg')).text();
            svgText = svgText
                .replace(/_x21_/g, '!')
                .replace(/_x40_/g, '@')
                .replace(/_x23_/g, '#')
                .replace(/_x24_/g, '$')
                .replace(/_x25_/g, '%')
                .replace(/_x5E_/g, '^')
                .replace(/_x26_/g, '&')
                .replace(/_x2A_/g, '*')
                .replace(/_x28_/g, '(')
                .replace(/_x29_/g, ')')
                .replace(/_x2D_/g, '-')
                .replace(/_x5F_/g, '_')
                .replace(/_x2B_/g, '+')
                .replace(/_x3D_/g, '=')
                .replace(/_x2C_/g, ',')
                .replace(/<\?xml(.*?)>/g, '')
                .replace(/<!--(.*?)-->/g, '')
                .replace('xlink:href="', 'xlink:href="./svg/');
            console.log(svgText);
            document.getElementById('container').innerHTML = svgText;

            initPages();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        let svgRootTag,
            theView;
        const initPages = async () => {

            svgRootTag = document.querySelector('svg');
            theView = new AiJs.View(
                svgRootTag,
                {
                    isMobile: true,
                    isHorizontal: true,
                }
            );

            await new Promise(res => setTimeout(res, 100));

            MissionCache.allPages =
                Array
                    .from(document.querySelectorAll('[id^="Page"]'))
                    .filter(page => page.style.display != 'none')
                    .sort((a, b) => {
                        return a.id.split('@')[1] - b.id.split('@')[1];
                    });


            let currentPageIndex = 0;
            window.updatePageIndex = () => {
                MissionCache.allPages.forEach((pageG, rindex) => {
                    pageG.style.transform = `translateY(${rindex * 100 - currentPageIndex * 100}%)`;
                });
            };


            window.changePage = toNext => {
                toNext
                    ? currentPageIndex++
                    : currentPageIndex--;
                updatePageIndex();
            };


            initContent();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const initContent = async () => {
            Array.from(
                document.querySelectorAll('[id^="in"]'))
                .map(tag => {
                    tag.id = tag.id.replace(/_\d\d?\d?_/, '');

                    let transformerObj = new AiJs.Transformer(tag);
                    transformerObj.transformElement.id = tag.id;
                    tag.id = '';

                    return transformerObj;
                })
                .forEach(tObj => {

                    MissionCache.allInteractive.push(tObj);

                    const tag = tObj.transformElement;
                    // console.log('tag.id', tag.id);

                    const allAttributes = tag.id.split('::');
                    // console.log('allAttributes', allAttributes);

                    {
                        // extract name
                        const eleName = allAttributes[1];
                        if (eleName != '*') {
                            if (!MissionCache.namedObj[eleName]) MissionCache.namedObj[eleName] = [];
                            MissionCache.namedObj[eleName].push(tObj);
                        }

                        // extract element with transition
                        if (allAttributes.some(attri => attri.includes('transition=')))
                            MissionCache.transitioner.push(tag);

                        // extract action
                        if (allAttributes.some(attri => attri.startsWith('Act')))
                            MissionCache.actElement.push(tObj);

                        // extract page change elements
                        if (allAttributes.some(attri => attri.startsWith('Page')))
                            MissionCache.pageChanger.push(tObj);

                        // extract game set
                        if (allAttributes.some(attri => attri.startsWith('GameSet')))
                            MissionCache.gameSet.push(tObj);
                    }
                });

            MissionContent.UpdateAction(MissionCache);

            loadFinish();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const loadFinish = async () => {

            if (document.querySelector('image')) {
                await new Promise(res => setTimeout(res, 50));
                await new Promise(res => {
                    console.log('loading img');
                    console.log('svgRootTag', svgRootTag);
                    AiJs.Library.LoadImageSrc(svgRootTag, { xLinked: true, removeSrc: true, loadedNum: per => { if (per > 0.95) res(); } });
                    console.log('all img loaded.');
                });
                await new Promise(subRes => setTimeout(subRes, 50));
            }

            document.getElementById('container').style.transition = 'all 0.4s linear';
            document.getElementById('container').style.opacity = 1;


            MissionCache.transitioner.forEach(tag => {
                UpdateTransition(tag);
            });

            updatePageIndex();

            setTimeout(() => {
                MissionCache.allPages.forEach(pageTag => {
                    pageTag.style.transition = 'all 0.4s ease';
                });
            }, 100);

            console.log('MissionCache', MissionCache);
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        function fS() {
            const b = document.body;
            if (b.requestFullscreen) {
                b.requestFullscreen();
            } else if (b.webkitRequestFullscreen) { /* Safari */
                b.webkitRequestFullscreen();
            } else if (b.msRequestFullscreen) { /* IE11 */
                b.msRequestFullscreen();
            }
        }


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        start();
        window.onresize = () => {
            theView = new AiJs.View(
                svgRootTag,
                {
                    isMobile: true,
                    isHorizontal: true,
                }
            );
        };
    </script>
</body>