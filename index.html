<head>
    <style>
        * {
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
        }
    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>

<body>

    <div id="container"></div>

    <script src="./lib/aijs.build4.js"></script>
    <script src="./_lib/InitSvgText.js"></script>
    <script src="./_lib/InitSvgView.js"></script>
    <script src="./_lib/InitAudio.js"></script>
    <script src="./_lib/InsertPageConfiguration.js"></script>
    <script src="./_lib/InitPages.js"></script>
    <script src="./_lib/SubtitleInteractiveByTransformer.js"></script>
    <script src="./_lib/InitPagingNav.js"></script>
    <script src="./_lib/InitAction.js"></script>
    <script src="./_lib/UpdateNavElement.js"></script>
    <script src="./_lib/UpdateTransition.js"></script>
    <script src="./_lib/GameSet.js"></script>


    <!-- <script src="./lib/pageConfig.js"></script> -->
    <!-- <script src="./lib/audio.js"></script> -->
    <!-- <script src="./lib/gameSet.js"></script> -->
    <!-- <script src="./lib/updateNav.js"></script> -->
    <!-- <script src="./lib/updateAction.js"></script> -->
    <!-- <script src="./lib/updateTransition.js"></script> -->

    <script>
        window.AiGUI = {};

        const start = async () => {

            // hide container
            document.getElementById('container').style.opacity = 0;

            await InitSvgText(document.getElementById('container'));
            await InitSvgView();
            await InitAudio();

            const laterUpdateTransition = await InsertPageConfiguration();

            await InitPages();
            await SubtitleInteractiveByTransformer();
            await InitPagingNav();
            await InitAction();
            await UpdateNavElement();

            // add game set functionality
            GameSet.init();

            // preload image
            if (document.querySelector('image')) {
                await new Promise(res => {
                    AiJs
                        .Library
                        .LoadImageSrc(
                            AiGUI.SvgRootTag,
                            {
                                xLinked: true,
                                removeSrc: true,
                                loadedNum: per => { if (per > 0.95) res(); }
                            }
                        );
                });
            }

            await new Promise(res => setTimeout(res, 50));

            // show container
            document.getElementById('container').style.transition = 'all 0.4s linear';
            document.getElementById('container').style.opacity = 1;

            // update in::transition element transition
            await UpdateTransition();

            // arrange page position
            window.AiGUI.ChangePage(true);

            laterUpdateTransition();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-




        const initPages = async () => {

            await AudioInit();



            MissionCache.svgRootTag = svgRootTag;

            await new Promise(res => setTimeout(res, 100));

            MissionCache.allPages =
                Array
                    .from(document.querySelectorAll('[id^="Page"]'))
                    .filter(page => page.style.display != 'none' && page.getAttribute('display') != 'none')
                    .map(pageTag => {
                        pageTag.classList.add('pageContainer');
                        pageTag.id = pageTag.id.split('_')[0];
                        return pageTag;
                    })
                    .sort((a, b) => {
                        return a.id.split('@')[1] - b.id.split('@')[1];
                    });


            let currentPageIndex = -1;
            window.updatePageByIndex = () => PageConfiguration(MissionCache.allPages, currentPageIndex);


            window.changePage = toNext => {
                // console.log('toNext', toNext);
                if (typeof toNext === 'boolean') {
                    toNext
                        ? currentPageIndex++
                        : currentPageIndex--;
                }
                else if (typeof toNext === 'number') {
                    currentPageIndex = toNext;
                }
                updatePageByIndex();

                MissionCache.allPages.forEach((pageTag, pageIndex) => {
                    if (pageIndex === currentPageIndex) {
                        pageTag.classList.add('activated');
                        pageTag.classList.remove('deactivated');
                    } else {
                        pageTag.classList.add('deactivated');
                        pageTag.classList.remove('activated');
                    }
                });

                // console.log('changePageCallback', changePageCallback);
                changePageCallback.forEach(func => func(currentPageIndex, MissionCache.allPages.length));
            };


            initContent();
        };
        window.changePageCallback = [];


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const initContent = async () => {
            Array.from(
                document.querySelectorAll('[id^="in"]'))
                .map(tag => {

                    // remove _1_ or similar char in id
                    tag.id = tag.id.replace(/_\d\d?\d?_/, '');


                    // create transformer for all as standard
                    let transformerObj = new AiJs.Transformer(tag);
                    transformerObj.transformElement.id = tag.id;
                    tag.id = '';


                    // interchange of opacity
                    transformerObj.transformElement.style.opacity = (tag.style.opacity || tag.getAttribute('opacity'));
                    tag.style.opacity = 1;


                    return transformerObj;
                })
                .forEach(tObj => {

                    // cache all in:: object
                    MissionCache.allInteractive.push(tObj);


                    const tag = tObj.transformElement;


                    const allAttributes = tag.id.split('::');
                    // console.log('allAttributes', allAttributes);


                    {
                        // extract name
                        const eleName = allAttributes[1];
                        if (eleName != '*') {
                            if (!MissionCache.namedObj[eleName]) MissionCache.namedObj[eleName] = [];
                            MissionCache.namedObj[eleName].push(tObj);
                        }

                        // extract element with transition
                        if (allAttributes.some(attri => attri.includes('transition=')))
                            MissionCache.transitioner.push(tag);

                        // extract action
                        if (allAttributes.some(attri => attri.startsWith('Act')))
                            MissionCache.actElement.push(tObj);

                        // extract page change elements
                        if (allAttributes.some(attri => attri.startsWith('Page')))
                            MissionCache.pageChanger.push(tObj);

                        // extract Nav elements
                        if (allAttributes.some(attri => attri.startsWith('Nav')))
                            MissionCache.navElements.push(tObj);

                        // extract PlayOn elements
                        if (allAttributes.some(attri => attri.startsWith('PlayOn')))
                            MissionCache.playOns.push(tObj);

                        // extract game set
                        if (allAttributes.some(attri => attri.startsWith('GameSet')))
                            MissionCache.gameSet.push(tObj);
                    }
                });


            // add action functionality to element                
            MissionContent.UpdateAction();


            // nav element listen action
            UpdateNav();


            // add game set functionality
            GameSet.init();


            loadFinish();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const loadFinish = async () => {

            // load image
            if (document.querySelector('image')) {
                await new Promise(res => setTimeout(res, 50));
                await new Promise(res => {
                    // console.log('loading img');
                    // console.log('svgRootTag', svgRootTag);
                    AiJs.Library.LoadImageSrc(svgRootTag, { xLinked: true, removeSrc: true, loadedNum: per => { if (per > 0.95) res(); } });
                    // console.log('all img loaded.');
                });
                await new Promise(subRes => setTimeout(subRes, 50));
            }


            // show container
            document.getElementById('container').style.transition = 'all 0.4s linear';
            document.getElementById('container').style.opacity = 1;


            // update in::transition element transition
            MissionCache.transitioner.forEach(tag => {
                UpdateTransition(tag);
            });


            // arrange page position
            changePage(true);


            // setup page transition after first position update
            setTimeout(() => {
                MissionCache.allPages.forEach(pageTag => {
                    pageTag.style.transition = window.thePageTransition;
                });
            }, 100);


            // console.log('MissionCache', MissionCache);
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        start();
        setTimeout(() => {
            window.onresize = () => {
                theView = new AiJs.View(
                    svgRootTag,
                    {
                        isMobile: true,
                        isHorizontal: true,
                    }
                );
            };
        }, 1000);
    </script>
</body>