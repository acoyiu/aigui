<head>
    <style>
        * {
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        #fsBut {
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 999999;
        }
    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="./lib/foreignHandle.css">
</head>

<body>

    <button id="fsBut" onclick="fS()">Full Screen</button>
    <div id="container"></div>

    <script src="./lib/pageConfig.js"></script>
    <script src="./lib/aijs.build4.js"></script>
    <script src="./lib/audio.js"></script>
    <script src="./lib/gameSet.js"></script>
    <script src="./lib/updateNav.js"></script>
    <script src="./lib/updateAction.js"></script>
    <script src="./lib/foreignHandle.js"></script>
    <script src="./lib/updateTransition.js"></script>

    <script>
        // remove log
        console.log('add "?log" after url for showing logs.');
        if (!window.location.search.includes('log'))
            console.log = () => { };


        const MissionCache = {
            allPages: [],
            namedObj: {},
            gameSet: [],
            actElement: [],
            navElements: [],
            pageChanger: [],
            transitioner: [],
            foreignThings: [],
            allInteractive: [],
        };

        const start = async () => {
            document.getElementById('container').style.opacity = 0;

            let svgText;
            if (!window.location.search.includes('default')) svgText = await (await fetch('./target/index.svg')).text();
            else svgText = await (await fetch('./svg/index.svg')).text();

            svgText = svgText
                .replace(/_x21_/g, '!')
                .replace(/_x40_/g, '@')
                .replace(/_x23_/g, '#')
                .replace(/_x24_/g, '$')
                .replace(/_x25_/g, '%')
                .replace(/_x5E_/g, '^')
                .replace(/_x26_/g, '&')
                .replace(/_x2A_/g, '*')
                .replace(/_x28_/g, '(')
                .replace(/_x29_/g, ')')
                .replace(/_x2D_/g, '-')
                .replace(/_x5F_/g, '_')
                .replace(/_x2B_/g, '+')
                .replace(/_x3D_/g, '=')
                .replace(/_x2C_/g, ',')
                .replace(/<\?xml(.*?)>/g, '')
                .replace(/<!--(.*?)-->/g, '')
                .replace(
                    /xlink\:href\=\"/g,
                    window.location.search.includes('default')
                        ? 'xlink:href="./svg/'
                        : 'xlink:href="./target/'
                );
            console.log(svgText);
            document.getElementById('container').innerHTML = svgText;

            initPages();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        let svgRootTag,
            theView;

        const initPages = async () => {

            await AudioInit();

            svgRootTag = document.querySelector('svg');
            theView = new AiJs.View(
                svgRootTag,
                {
                    isMobile: true,
                    isHorizontal: true,
                }
            );

            MissionCache.svgRootTag = svgRootTag;

            await new Promise(res => setTimeout(res, 100));

            MissionCache.allPages =
                Array
                    .from(document.querySelectorAll('[id^="Page"]'))
                    .filter(page => page.style.display != 'none' && page.getAttribute('display') != 'none')
                    .map(pageTag => {
                        pageTag.id = pageTag.id.split('_')[0];
                        return pageTag;
                    })
                    .sort((a, b) => {
                        return a.id.split('@')[1] - b.id.split('@')[1];
                    });


            let currentPageIndex = -1;
            window.updatePageByIndex = () => PageConfiguration(MissionCache.allPages, currentPageIndex);


            window.changePage = toNext => {
                toNext
                    ? currentPageIndex++
                    : currentPageIndex--;
                updatePageByIndex();
                changePageCallback.forEach(func => func(currentPageIndex, MissionCache.allPages.length));
            };


            // ForeignHandle();


            initContent();
        };
        window.changePageCallback = [];


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const initContent = async () => {
            Array.from(
                document.querySelectorAll('[id^="in"]'))
                .map(tag => {

                    // remove _1_ or similar char in id
                    tag.id = tag.id.replace(/_\d\d?\d?_/, '');


                    // create transformer for all as standard
                    let transformerObj = new AiJs.Transformer(tag);
                    transformerObj.transformElement.id = tag.id;
                    tag.id = '';


                    // interchange of opacity
                    transformerObj.transformElement.style.opacity = (tag.style.opacity || tag.getAttribute('opacity'));
                    tag.style.opacity = 1;


                    return transformerObj;
                })
                .forEach(tObj => {

                    // cache all in:: object
                    MissionCache.allInteractive.push(tObj);


                    const tag = tObj.transformElement;


                    const allAttributes = tag.id.split('::');
                    // console.log('allAttributes', allAttributes);


                    {
                        // extract name
                        const eleName = allAttributes[1];
                        if (eleName != '*') {
                            if (!MissionCache.namedObj[eleName]) MissionCache.namedObj[eleName] = [];
                            MissionCache.namedObj[eleName].push(tObj);
                        }

                        // extract element with transition
                        if (allAttributes.some(attri => attri.includes('transition=')))
                            MissionCache.transitioner.push(tag);

                        // extract action
                        if (allAttributes.some(attri => attri.startsWith('Act')))
                            MissionCache.actElement.push(tObj);

                        // extract page change elements
                        if (allAttributes.some(attri => attri.startsWith('Page')))
                            MissionCache.pageChanger.push(tObj);

                        // extract Nav elements
                        if (allAttributes.some(attri => attri.startsWith('Nav')))
                            MissionCache.navElements.push(tObj);

                        // extract game set
                        if (allAttributes.some(attri => attri.startsWith('GameSet')))
                            MissionCache.gameSet.push(tObj);
                    }
                });


            // add action functionality to element                
            MissionContent.UpdateAction();


            // nav element listen action
            UpdateNav();


            // add game set functionality
            GameSet.init();


            loadFinish();
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        const loadFinish = async () => {

            // load image
            if (document.querySelector('image')) {
                await new Promise(res => setTimeout(res, 50));
                await new Promise(res => {
                    console.log('loading img');
                    console.log('svgRootTag', svgRootTag);
                    AiJs.Library.LoadImageSrc(svgRootTag, { xLinked: true, removeSrc: true, loadedNum: per => { if (per > 0.95) res(); } });
                    console.log('all img loaded.');
                });
                await new Promise(subRes => setTimeout(subRes, 50));
            }


            // show container
            document.getElementById('container').style.transition = 'all 0.4s linear';
            document.getElementById('container').style.opacity = 1;


            // update in::transition element transition
            MissionCache.transitioner.forEach(tag => {
                UpdateTransition(tag);
            });


            // arrange page position
            changePage(true);


            // setup page transition after first position update
            setTimeout(() => {
                MissionCache.allPages.forEach(pageTag => {
                    pageTag.style.transition = window.thePageTransition;
                });
            }, 100);


            console.log('MissionCache', MissionCache);
        };


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        function fS() {
            const b = document.body;
            if (b.requestFullscreen) {
                b.requestFullscreen();
            } else if (b.webkitRequestFullscreen) { /* Safari */
                b.webkitRequestFullscreen();
            } else if (b.msRequestFullscreen) { /* IE11 */
                b.msRequestFullscreen();
            }
        }


        // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-


        start();
        setTimeout(() => {
            window.onresize = () => {
                theView = new AiJs.View(
                    svgRootTag,
                    {
                        isMobile: true,
                        isHorizontal: true,
                    }
                );
            };
        }, 1000);
    </script>
</body>